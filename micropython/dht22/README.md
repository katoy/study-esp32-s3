# DHT22センサーによる温度・湿度測定

このプロジェクトは、MicroPythonを使用してDHT22温湿度センサーからデータを読み取るためのサンプルです。

## 必要なもの

*   ESP32-S3 開発ボード (または他のMicroPython対応ボード)
*   DHT22 温湿度センサー (4ピン)
*   4.7KΩ～10KΩ 抵抗 × 1
*   ブレッドボード
*   ジャンパーワイヤー

## 配線

以下のようにコンポーネントを配線します。データピン(DATA)は4.7KΩ～10KΩの抵抗でプルアップしています。

```
      +-----------------+
      |   ESP32-S3      |
      |                 |
      |      3.3V ------+----o------> DHT22 VCC (Pin 1)
      |                 |    |
      |                 |   [R] 4.7K-10KΩ
      |                 |    |
      |      GPIO 4 ----+----o------> DHT22 DATA (Pin 2)
      |                 |
      |                 |             DHT22 NC (Pin 3) は接続しません
      |                 |
      |       GND ------+------------> DHT22 GND (Pin 4)
      |                 |
      +-----------------+
```

**ピンの対応:**

| DHT22ピン | 接続先                      |
| :-------- | :-------------------------- |
| VCC (1)   | ESP32-S3 3.3V               |
| DATA (2)  | ESP32-S3 **GPIO 4** (推奨)   |
| NC (3)    | (未接続)                    |
| GND (4)   | ESP32-S3 GND       |

**重要な注意点:**
- DATAピンと3.3V電源の間に4.7KΩ～10KΩのプルアップ抵抗を接続してください
- **ESP32-S3ではGPIO4が最も安定**して動作します（診断結果に基づく推奨）
- GPIO1は初期化は可能ですが、測定時にETIMEDOUTエラーが発生する場合があります
- 代替ピン: GPIO2, GPIO5, GPIO15, GPIO16も使用可能（ただし個体差あり）

## プロジェクト構成

```
dht22/
├── README.md                    # このファイル
├── sample-dht22-01.py          # 基本版（GPIO4使用）
└── repl-diagnosis.py           # REPL診断ツール
```

## 使い方

### 基本的な測定

1. **配線**: 上記の配線図に従って、ESP32-S3とDHT22センサーを接続
   - **重要**: GPIO4をDATAピンとして使用（ESP32-S3で最も安定）
   - プルアップ抵抗（4.7KΩ）を必ず接続

2. **ファイル転送**: `sample-dht22-01.py`をMicroPythonボードに転送

3. **実行**: Thonny IDEまたはREPLで実行
   ```python
   exec(open('sample-dht22-01.py').read())
   ```

### 問題診断

DHT22が動作しない場合、診断ツールを使用：

```python
exec(open('repl-diagnosis.py').read())
```

診断ツールは以下を自動実行：
- 各GPIOピンの基本動作テスト
- DHT22センサーとの通信テスト
- 最適なピン設定の推奨

## トラブルシューティング

### ETIMEDOUTエラーが発生する場合

**症状**: `[Errno 116] ETIMEDOUT` エラーが繰り返し発生

**原因と対策**:

1. **配線の確認**
   - DATAピン（**GPIO4推奨**）とセンサーのDATAピン（2番ピン）が確実に接続されているか
   - ブレッドボードの接触不良がないか（特にデータライン）
   - ジャンパーワイヤーを別のものに交換してテスト

2. **プルアップ抵抗の確認**
   - 4.7KΩ〜10KΩの抵抗がDATAピンと3.3V間に接続されているか
   - 抵抗値が適切か（マルチメーターで測定）
   - 抵抗の接続が確実か

3. **電源供給の確認**
   - 3.3V電源が安定して供給されているか
   - GNDが確実に接続されているか
   - 他のセンサーや負荷による電圧降下がないか

4. **センサー自体の確認**
   - DHT22センサーが物理的に損傷していないか
   - 別のDHT22センサーでテストしてみる
   - センサーの向きが正しいか（ピン配置の確認）

5. **ソフトウェア的な対策**
   - 測定間隔を2秒以上に設定（DHT22の仕様）
   - **GPIO4が推奨**（診断で動作確認済み）
   - GPIO2, GPIO5, GPIO15, GPIO16等の代替ピンでテスト
   - `repl-diagnosis.py`を実行して自動診断を行う

### ESP32-S3でのピン互換性（診断結果）

| GPIO | 動作状況 | 備考 |
|------|---------|------|
| **GPIO4** | ✅ **推奨** | 安定動作確認済み |
| GPIO1 | ⚠️ 制限あり | 初期化OK、測定でETIMEDOUT |
| GPIO2 | ❌ 非推奨 | 測定でETIMEDOUT |
| GPIO5 | ❌ 非推奨 | 測定でETIMEDOUT |
| GPIO15-18 | ❌ 非推奨 | 測定でETIMEDOUT |

### 診断ツールの使用

問題の特定には診断ツールを活用してください：

```python
# ESP32-S3のREPLで実行
exec(open('repl-diagnosis.py').read())
```

診断ツールは以下を自動実行：
- 各GPIOピンの基本動作テスト
- DHT22センサーとの通信テスト
- 最適なピン設定の推奨
- 実際の温度・湿度測定テスト

### よくある問題と解決策

| 問題 | 症状 | 解決策 |
|------|------|--------|
| 配線ミス | 常にETIMEDOUT | 配線図と実際の接続を再確認 |
| プルアップ抵抗なし | 不安定な読み取り | 4.7KΩ抵抗をDATA-3.3V間に追加 |
| 電源不足 | 間欠的なエラー | 3.3V電源の安定化、別電源の使用 |
| センサー故障 | 全く応答なし | 別のDHT22センサーと交換 |
| ピン制約 | GPIO1で動作しない | **GPIO4を使用（ESP32-S3推奨）** |

### ハードウェア推奨事項

- **プルアップ抵抗**: 4.7KΩ推奨（10KΩでも可）
- **配線長**: できるだけ短く（20cm以内）
- **ブレッドボード**: 接触の良い品質の良いものを使用
- **電源**: 安定した3.3V供給（レギュレーター使用推奨）

## 実行結果例

正常に動作すると、以下のような出力が表示されます：

```
Temperature: 27.8, Humidity: 56.7
Temperature: 27.9, Humidity: 56.5
Temperature: 27.8, Humidity: 56.8
...
```

## 技術仕様

### DHT22センサー仕様
- **湿度測定範囲**: 0-100% RH
- **温度測定範囲**: -40～80°C
- **湿度精度**: ±2-5% RH
- **温度精度**: ±0.5°C
- **最小測定間隔**: 2秒
- **電源電圧**: 3.3V～5V

### ESP32-S3対応状況
- **推奨ピン**: GPIO4（診断で動作確認済み）
- **動作しないピン**: GPIO1, GPIO2, GPIO5, GPIO15-18
- **プルアップ抵抗**: 4.7KΩ（必須）
- **測定間隔**: 2秒以上推奨
