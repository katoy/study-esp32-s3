# BleSee.app を使用した PICO_LED 手動テスト

このガイドでは、macOSのBluetoothユーティリティアプリ「BleSee」を使用して、Raspberry Pi Pico W2の`pico_led.py`デバイスを手動でテストする方法を説明します。

## 前提条件

### 1. BleSee のインストール
```bash
# Homebrew Cask でインストール
brew install --cask blesee
```

または、Mac App Storeからダウンロード

### 2. Raspberry Pi Pico W2 の準備
- 以下のファイルをRaspberry Pi Pico W2にアップロード：
  - `../pico_led.py`
  - `../ble_simple_peripheral.py`
  - `../ble_advertising.py`
- `pico_led.py`を実行してBLEペリフェラルとして動作させる

## BleSee を使用した手動テスト手順

### ステップ 1: BleSee の起動とデバイス検索

1. **BleSee.app を起動**
   - LaunchpadまたはApplicationsフォルダから起動

2. **デバイススキャンの開始**
   - 自動的にスキャンが開始される
   - または、「Scan」ボタンをクリック

3. **PICO_LED デバイスの確認**
   - スキャン結果リストで「PICO_LED」デバイスを探す
   - デバイス名の横にMACアドレスが表示される

### ステップ 2: デバイスへの接続

1. **接続の実行**
   - 「PICO_LED」デバイスをクリックして選択
   - 「Connect」ボタンをクリック

2. **接続状態の確認**
   - デバイス詳細画面が表示される
   - 接続ステータスが「Connected」に変わる

### ステップ 3: サービスと特性の確認

1. **サービスの表示**
   - 接続後、デバイス詳細画面でサービス一覧を確認
   - 「Services」タブまたはセクションを選択

2. **UART サービスの確認**
   - `6E400001-B5A3-F393-E0A9-E50E24DCCA9E` サービスを探す
   - 「Nordic UART Service」として表示される場合もある

3. **特性の確認**
   - UARTサービスをクリックして展開
   - 以下の特性が表示されることを確認：
     - **RX特性**: `6E400002-B5A3-F393-E0A9-E50E24DCCA9E` (Write)
     - **TX特性**: `6E400003-B5A3-F393-E0A9-E50E24DCCA9E` (Notify)

### ステップ 4: LED制御テスト

#### LED ON コマンドの送信

1. **RX特性の選択**
   - `6E400002-B5A3-F393-E0A9-E50E24DCCA9E` 特性をクリック

2. **データの入力**
   - 「Write Value」セクションで以下を入力：
   ```
   31 00
   ```
   または16進数形式で：
   ```
   0x31 0x00
   ```

3. **書き込みの実行**
   - 「Write」ボタンをクリック
   - Raspberry Pi Pico W2のLED（GPIO16）が点灯することを確認

#### LED OFF コマンドの送信

1. **データの入力**
   - 「Write Value」セクションで以下を入力：
   ```
   30 00
   ```
   または16進数形式で：
   ```
   0x30 0x00
   ```

2. **書き込みの実行**
   - 「Write」ボタンをクリック
   - Raspberry Pi Pico W2のLED（GPIO16）が消灯することを確認

### ステップ 5: 接続時の自動状態確認 🆕

1. **TX特性での通知有効化**
   - `6E400003-B5A3-F393-E0A9-E50E24DCCA9E` 特性をクリック
   - 「Subscribe」または「Notify」ボタンを有効化

2. **接続時の初期状態受信**
   - 接続が完了すると、デバイスから自動的に現在のLED状態が送信される
   - BleSeeの通知欄で以下のような値を受信:
     - `30 00` (ASCII '0' + NULL) = LED OFF
     - `31 00` (ASCII '1' + NULL) = LED ON

3. **デバイス側ログ確認** (MicroPythonコンソール)
   ```
   Connection established. Current LED state sent: 0
   ```

### ステップ 6: LED制御テスト

#### LED ON コマンドの送信
[前のステップ4の内容をここに移動]

#### LED OFF コマンドの送信  
[前のステップ4の内容をここに移動]

### ステップ 7: 通知の確認
   - 「Subscribe」または「Notify」ボタンをクリックして通知を有効にする

2. **レスポンスの確認**
   - LED制御コマンドを送信後、通知セクションにレスポンスが表示される
   - LED ON後: `31` (ASCII '1')
   - LED OFF後: `30` (ASCII '0')

## データ形式の詳細

### コマンド送信（RX特性への書き込み）

| 動作 | 16進数 | 10進数 | ASCII |
|------|---------|---------|--------|
| LED ON | 0x31 0x00 | 49 0 | '1' + NULL |
| LED OFF | 0x30 0x00 | 48 0 | '0' + NULL |

### レスポンス受信（TX特性からの通知）

| 状態 | 16進数 | 10進数 | ASCII |
|------|---------|---------|--------|
| LED ON状態 | 0x31 | 49 | '1' |
| LED OFF状態 | 0x30 | 48 | '0' |

## トラブルシューティング

### デバイスが見つからない場合

1. **スキャンの再実行**
   - 「Stop Scanning」→「Start Scanning」を繰り返す

2. **Raspberry Pi Pico W2の確認**
   - `pico_led.py`が正常に動作しているか確認
   - シリアルモニターでエラーメッセージを確認

3. **Bluetoothの再起動**
   - システム環境設定→Bluetooth→オフ/オン

### 接続できない場合

1. **既存接続の切断**
   - 他のデバイスからの接続がないか確認
   - Raspberry Pi Pico W2を再起動

2. **BleSee の再起動**
   - アプリケーションを完全に終了して再起動

### コマンドが効かない場合

1. **データ形式の確認**
   - 16進数表記が正しいか確認
   - NULL終端（0x00）が含まれているか確認

2. **特性の確認**
   - 正しいRX特性（Write用）に送信しているか確認

3. **配線の確認**
   - GPIO16にLEDが正しく接続されているか確認
   - GNDとの接続を確認

## 高度な使用方法

### 連続テスト

1. **繰り返し操作**
   - BleSeeで同じ操作を繰り返し実行
   - LED点滅パターンのテスト

### ログの確認

1. **通信ログの表示**
   - 送受信データの履歴を確認
   - タイムスタンプ付きのデータ確認

### 複数デバイスのテスト

1. **同時接続**
   - 複数のRaspberry Pi Pico W2デバイスに同時接続
   - デバイス名を区別してテスト

## 期待される動作

### 正常な場合
- ✅ デバイス「PICO_LED」がスキャン結果に表示
- ✅ 接続が成功し、ステータスが「Connected」に
- ✅ UART サービスと特性が正しく表示
- ✅ LED ON/OFFコマンドでLEDが制御される
- ✅ TX特性から適切なレスポンス通知を受信

### 異常な場合の確認項目
- ❌ スキャンでデバイスが見つからない → Raspberry Pi Pico W2の動作確認
- ❌ 接続に失敗 → 他デバイスからの接続確認、Raspberry Pi Pico W2再起動
- ❌ サービスが見つからない → UUIDの確認、ファームウェア確認
- ❌ LEDが反応しない → 配線確認、コマンド形式確認

## 技術仕様まとめ

```
デバイス名: PICO_LED
Service UUID: 6E400001-B5A3-F393-E0A9-E50E24DCCA9E
RX UUID (Write): 6E400002-B5A3-F393-E0A9-E50E24DCCA9E
TX UUID (Notify): 6E400003-B5A3-F393-E0A9-E50E24DCCA9E

LED ON:  [0x31, 0x00] = [49, 0] = ['1', NULL]
LED OFF: [0x30, 0x00] = [48, 0] = ['0', NULL]
```

## 関連ドキュメント

- **自動テスト**: `README_BLE_TEST.md` - 統合テストスクリプトの使用方法
- **テストスクリプト**: `ble_test_integrated.py` - コマンドラインでの自動BLEテスト
- **メインドキュメント**: `../README_BLE_TEST.md` - プロジェクト全体の概要

Response ON:  0x31 = 49 = '1'
Response OFF: 0x30 = 48 = '0'
```